<html>
<body>

<div id="test1">abc</div>

<script>
  (function() {
    const ws = new WebSocket('ws://' + window.location.host + '/client');
    let id = sessionStorage.testId;

    ws.onmessage = function(event) {
      const data = JSON.parse(event.data);
      console.log(data);

      if (data.type === 'id') {
        id = data.id;
        sessionStorage.testId = id;
      }

      if (data.type === 'code') {
        ws.send(JSON.stringify({
          type: 'started',
          id: id,
          code: data.code,
          time: data.time,
          tid: data.tid
        }));

        try {
          const result = Function('"use strict";return ' + data.code + '')();
          ws.send(JSON.stringify({
            type: 'done',
            id: id,
            code: data.code,
            time: data.time,
            tid: data.tid,
            result: result }));
        } catch (e) {
          ws.send(JSON.stringify({
            type: 'error',
            id: id,
            code: data.code,
            time: data.time,
            tid: data.tid,
            result: e.message,
            browser: window.navigator.userAgent
          }));
        }
      }
    };

    ws.onopen = function() {
      ws.send(JSON.stringify({type: 'init', id: id}));
    };

  })();

  showtest2 = () => setTimeout(function() {
    document.querySelector('body').insertAdjacentHTML('beforeend', '<div id="test2">abc 2</div>');
  }, 2000);
</script>
<button onclick="showtest2()" id="clickme">show</button>
</body>

</html>
